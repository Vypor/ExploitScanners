use strict;
use threads;
use threads::shared;
use Thread::Queue;
use IO::Socket;

if ( $#ARGV != 3 ) {
    print "Usage: pmascan.pl <iplist> <folderlist> <threads> <output>\n";
    print "Coded by Vypor, https://github.com/Vypor\n";
    print "v.0.2, PMA exploit scanner\n";
    exit(1);
}

my $iplist        = $ARGV[0];
my $directorylist = $ARGV[1];
our $MAX //= $ARGV[2];
my $logfile = $ARGV[3];

my $foundpma : shared = 0;
my $donepma : shared  = 0;

local $| = 1;

open( FILE, $iplist );
my @lines = <FILE>;
close(FILE);
my $totalpma = @lines;

open my $directorys, '<', $directorylist;
chomp( my @directorys = <$directorys> );
close $directorys;

print "Starting Scan...\n";
print "IP list: $iplist\n";
print "Directory List: $directorylist\n";
print "Log File: $logfile\n";
print "Threads: $MAX\n";
print "Loading Threads...\n\n";

my $Q = new Thread::Queue;

sub thread {
    while ( my $ip = $Q->dequeue ) {

        foreach (@directorys) {
            my $socket = IO::Socket::INET->new(
                Proto    => 'tcp',
                PeerAddr => $ip,
                PeerPort => '80',
                Timeout  => '4',
            ) or return $!;
            my $doneurl = "http://" . $ip . "/" . $_ . "/scripts/setup.php";
            print $socket "GET /" . $_ . "/scripts/setup.php HTTP/1.0\r\n";
            print $socket "Host: ", $ip, "\r\n";
            print $socket "Connection: close", "\r\n";
            print $socket "User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)", "\r\n";
            print $socket "Accept: text/html, application/xhtml+xml, */*", "\r\n\r\n";

            my @array = <$socket>;
            my $pagetext = join( '', @array );

            if ( $pagetext =~ /You want to configure/ ) {
                lock($foundpma);
                $foundpma++;

                print "Found: $foundpma | Total: $donepma/$totalpma\r";
                open( LOGFILE, ">>$logfile" );
                print LOGFILE "$doneurl\n";
                close(LOGFILE);
                last;
            }
            else {
                print "Found: $foundpma | Total: $donepma/$totalpma\r";
            }
            lock($donepma);
            $donepma++;
        }

    }
}

my @threads = map async( \&thread ), 1 .. $MAX;

open my $handle, '<', $iplist;
chomp, $Q->enqueue($_) while defined( $_ = <$handle> );
close $handle;

$Q->enqueue( (undef) x $MAX );
$_->join for @threads;
